<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HD Spark Plug Scanner - SMKN 1 Sumarorong</title>
    <style>
        :root { --bg: #020617; --gold: #fbbf24; --text: #f8fafc; --accent: #3b82f6; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; overflow: hidden; }
        
        /* Viewport Kamera HD */
        #viewport { position: relative; width: 100vw; height: 100vh; background: #000; }
        #video { width: 100%; height: 100%; object-fit: cover; }
        
        /* Overlay Pemandu Presisi */
        .overlay {
            position: absolute; inset: 0;
            border: 2px solid rgba(255,255,255,0.1);
            pointer-events: none; display: flex; align-items: center; justify-content: center;
        }
        /* Kotak Fokus Super Kecil (3mm-5mm target area) */
        .target-box {
            width: 80px; height: 80px;
            border: 2px solid var(--gold);
            background: rgba(251, 191, 36, 0.1);
            box-shadow: 0 0 0 5000px rgba(0,0,0,0.6); /* Gelapkan sekeliling agar fokus */
            position: relative;
        }
        .target-box::after {
            content: "DEKATKAN HINGGA TAJAM";
            position: absolute; top: -30px; left: 50%; transform: translateX(-50%);
            font-size: 10px; color: var(--gold); white-space: nowrap; font-weight: bold;
        }

        /* Panel Hasil & Kontrol */
        .ui-panel {
            position: fixed; bottom: 0; width: 100%;
            background: #1e293b; padding: 20px;
            border-radius: 25px 25px 0 0; border-top: 3px solid var(--gold);
            box-sizing: border-box; z-index: 100;
        }
        .btn {
            background: var(--gold); color: #000; border: none; padding: 18px;
            width: 100%; border-radius: 15px; font-weight: 900; font-size: 1rem; cursor: pointer;
        }
        
        #result { display: none; margin-top: 15px; }
        .res-row { display: flex; gap: 15px; margin-bottom: 15px; align-items: center; }
        .color-preview { width: 50px; height: 50px; border-radius: 10px; border: 2px solid #fff; }
        .info-box { background: #0f172a; padding: 12px; border-radius: 10px; margin-bottom: 8px; border-left: 4px solid var(--accent); }
        .info-box label { font-size: 0.65rem; color: var(--gold); font-weight: bold; display: block; }
        .info-box p { margin: 4px 0 0; font-size: 0.85rem; line-height: 1.4; }
        
        canvas { display: none; }
    </style>
</head>
<body>

<div id="viewport">
    <video id="video" autoplay playsinline></video>
    <div class="overlay">
        <div class="target-box"></div>
    </div>
</div>

<div class="ui-panel">
    <div id="result">
        <div class="res-row">
            <div id="resCol" class="color-preview"></div>
            <div>
                <h3 id="resName" style="margin:0; color:var(--gold); text-transform:uppercase;">-</h3>
                <small id="resHex" style="opacity:0.6"></small>
            </div>
        </div>
        <div class="info-box"><label>INDIKASI</label><p id="resInd">-</p></div>
        <div class="info-box"><label>PENYEBAB</label><p id="resPen">-</p></div>
        <div class="info-box" style="border-left-color: #10b981;"><label>PERBAIKAN</label><p id="resSol">-</p></div>
        <button class="btn" style="background:#475569; color:white; margin-top:10px;" onclick="resetScan()">SCAN ULANG</button>
    </div>

    <button id="snap" class="btn">AMBIL FOTO & ANALISIS HD</button>
</div>

<canvas id="canvas"></canvas>

<script>
    // Library Database diperkaya (15 Kondisi)
    const DB = [
        { name: "Normal (Tan)", rgb: [188, 150, 120], ind: "Mesin sehat, pembakaran efisien.", pen: "Setelan karburator/injeksi tepat.", sol: "Perawatan rutin, tidak perlu ganti." },
        { name: "Carbon Fouling", rgb: [40, 40, 40], ind: "Jelaga hitam kering.", pen: "Bensin boros atau filter udara kotor.", sol: "Bersihkan filter & setel ulang BBM." },
        { name: "Oil Fouling", rgb: [10, 10, 10], ind: "Basah oli, hitam pekat.", pen: "Ring piston/seal klep bocor.", sol: "Overhaul / bongkar mesin." },
        { name: "Overheated", rgb: [245, 245, 245], ind: "Putih melepuh, elektroda botak.", pen: "Bensin oktan rendah atau busi terlalu panas.", sol: "Ganti bensin oktan tinggi & busi dingin." },
        { name: "Ash Deposit", rgb: [170, 170, 170], ind: "Tumpukan abu kelabu.", pen: "Kualitas oli buruk atau aditif bensin.", sol: "Ganti merk oli mesin." },
        { name: "Detonasi", rgb: [210, 210, 210], ind: "Insulator retak/pecah.", pen: "Ngelitik parah (Knocking).", sol: "Setel timing pengapian & oktan." },
        { name: "Glazing", rgb: [120, 90, 60], ind: "Coklat mengkilap seperti kaca.", pen: "Suhu naik ekstrem tiba-tiba.", sol: "Ganti busi baru." },
        { name: "Aluminium Splash", rgb: [200, 200, 205], ind: "Bintik logam perak.", pen: "Piston mulai meleleh.", sol: "Bahaya! Segera cek piston." },
        { name: "Lead Fouling", rgb: [140, 120, 80], ind: "Coklat kekuningan tebal.", pen: "Bahan bakar mengandung timbal.", sol: "Ganti bensin & kuras tangki." },
        { name: "Busi Baru", rgb: [230, 230, 230], ind: "Putih bersih standar.", pen: "Belum ada deposit.", sol: "Siap digunakan." }
    ];

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const snapBtn = document.getElementById('snap');
    const resDiv = document.getElementById('result');

    async function startHD() {
        try {
            // Meminta resolusi HD maksimal tanpa zoom digital agar jernih
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: "environment",
                    width: { ideal: 1920 },
                    height: { ideal: 1080 }
                } 
            });
            video.srcObject = stream;
            
            // Mengaktifkan Torch (Senter) jika didukung agar tajam
            const track = stream.getVideoTracks()[0];
            const caps = track.getCapabilities();
            if (caps.torch) {
                track.applyConstraints({ advanced: [{ torch: true }] });
            }
        } catch (e) { alert("Kamera HD tidak tersedia."); }
    }

    snapBtn.onclick = () => {
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);

        // Sampling di titik tengah kotak kuning
        const x = canvas.width / 2;
        const y = canvas.height / 2;
        const data = ctx.getImageData(x-20, y-20, 40, 40).data;

        let r=0, g=0, b=0;
        for(let i=0; i<data.length; i+=4) { r += data[i]; g += data[i+1]; b += data[i+2]; }
        const count = data.length / 4;
        
        showResult(Math.round(r/count), Math.round(g/count), Math.round(b/count));
    };

    function showResult(r, g, b) {
        let match = DB[0];
        let min = Infinity;
        DB.forEach(d => {
            const dist = Math.sqrt(Math.pow(r-d.rgb[0],2)+Math.pow(g-d.rgb[1],2)+Math.pow(b-d.rgb[2],2));
            if(dist < min) { min = dist; match = d; }
        });

        const hex = "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();
        document.getElementById('resCol').style.backgroundColor = hex;
        document.getElementById('resHex').innerText = `HEX: ${hex}`;
        document.getElementById('resName').innerText = match.name;
        document.getElementById('resInd').innerText = match.ind;
        document.getElementById('resPen').innerText = match.pen;
        document.getElementById('resSol').innerText = match.sol;

        resDiv.style.display = 'block';
        snapBtn.style.display = 'none';
        video.pause(); // Bekukan gambar agar siswa bisa membaca hasil
    }

    function resetScan() {
        resDiv.style.display = 'none';
        snapBtn.style.display = 'block';
        video.play();
    }

    window.onload = startHD;
</script>
</body>
</html>
