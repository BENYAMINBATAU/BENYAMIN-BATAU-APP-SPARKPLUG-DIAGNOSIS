<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expert Busi Scanner - SMKN 1 Sumarorong</title>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --gold: #fbbf24; --blue: #3b82f6; --text: #f8fafc; }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; overflow-x: hidden; }
        .card { width: 100%; max-width: 500px; margin: auto; background: var(--card); padding: 20px; border-radius: 30px; box-shadow: 0 25px 50px rgba(0,0,0,0.5); border: 1px solid #334155; box-sizing: border-box; }
        
        .header h1 { font-size: 1.4rem; color: var(--gold); margin: 0; text-transform: uppercase; font-weight: 900; text-align: center; }
        .header p { font-size: 0.7rem; color: #94a3b8; text-align: center; margin: 5px 0 15px 0; letter-spacing: 1px; }

        /* Live Camera Container */
        #camera-container { 
            width: 100%; height: 350px; background: #000; border-radius: 20px; 
            margin-bottom: 15px; position: relative; overflow: hidden; border: 2px solid #475569;
        }
        #video { width: 100%; height: 100%; object-fit: cover; }
        #photo-preview { width: 100%; height: 100%; object-fit: cover; display: none; position: absolute; top:0; left:0; }
        
        /* Overlay Fokus */
        .focus-ring {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 100px; height: 100px; border: 2px solid var(--gold); border-radius: 15px;
            pointer-events: none; transition: 0.3s; box-shadow: 0 0 0 1000px rgba(0,0,0,0.3);
        }
        .focus-ring::before { content: 'TEMPATKAN INSULATOR DI SINI'; position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%); font-size: 8px; color: var(--gold); width: 150px; text-align: center; font-weight: bold; }

        .controls { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .btn { 
            background: var(--gold); color: #000; padding: 16px; border-radius: 15px; 
            font-weight: 800; cursor: pointer; border: none; font-size: 1rem; transition: 0.2s;
        }
        .btn-blue { background: var(--blue); color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Result Section */
        #res { margin-top: 20px; padding: 15px; background: #0f172a; border-radius: 20px; display: none; border-top: 4px solid var(--gold); }
        .diag-header { display: flex; align-items: center; gap: 12px; margin-bottom: 15px; }
        .color-sample { width: 50px; height: 50px; border-radius: 10px; border: 2px solid #fff; }
        
        .box-info { background: #1e293b; padding: 10px; border-radius: 10px; margin-bottom: 8px; border-left: 3px solid var(--blue); }
        .box-info label { display: block; font-size: 0.65rem; color: #94a3b8; font-weight: 700; text-transform: uppercase; }
        .box-info p { margin: 3px 0 0 0; font-size: 0.85rem; color: #e2e8f0; }
        canvas { display: none; }
    </style>
</head>
<body>

<div class="card">
    <div class="header">
        <h1>BENYAMIN BATAU APP</h1>
        <p>LAB TSM SMKN 1 SUMARORONG</p>
    </div>

    <div id="camera-container" onclick="requestAutoFocus()">
        <video id="video" autoplay playsinline></video>
        <img id="photo-preview">
        <div class="focus-ring"></div>
    </div>

    <div class="controls">
        <button id="snap" class="btn">AMBIL & ANALISIS FOTO</button>
        <button id="reset" class="btn btn-blue" style="display:none">ULANGI SCAN</button>
    </div>

    <div id="res">
        <div class="diag-header">
            <div id="resCol" class="color-sample"></div>
            <div>
                <div id="resName" style="font-weight:900; color:var(--gold); font-size: 1rem;">-</div>
                <div id="resHex" style="font-size:0.6rem; color:#64748b; font-family:monospace;">HEX: #000000</div>
            </div>
        </div>
        <div class="box-info"><label>Analisis Kondisi</label><p id="resInd">-</p></div>
        <div class="box-info"><label>Kemungkinan Penyebab</label><p id="resPen">-</p></div>
        <div class="box-info" style="border-left-color:var(--gold)"><label>Tindakan Perbaikan</label><p id="resSol" style="color:var(--gold); font-weight:bold;">-</p></div>
    </div>
</div>

<canvas id="canvas"></canvas>

<script>
    // LIBRARY DATABASE WARNA & KERUSAKAN BUSI (12 KATEGORI EXPERT)
    const LIBRARY = [
        { name: "NORMAL (IDEAL)", rgb: [188, 158, 130], ind: "Warna coklat muda (Tan) atau abu-abu. Pembakaran sempurna.", pen: "Setelan AFR (Air Fuel Ratio) tepat dan pengapian sehat.", sol: "Bersihkan busi secara berkala, tidak perlu diganti." },
        { name: "KERAK KARBON (CARBON FOULING)", rgb: [30, 30, 30], ind: "Hitam kering berjelaga pada insulator dan elektroda.", pen: "Campuran terlalu boros, filter udara kotor, atau mesin sering idle lama.", sol: "Ganti filter udara, servis karburator/injeksi, cek sistem choke." },
        { name: "KERAK OLI (OIL FOULING)", rgb: [10, 10, 10], ind: "Hitam basah, berminyak, dan berkilat.", pen: "Kebocoran oli dari ring piston atau seal klep yang aus.", sol: "Perlu bongkar mesin untuk ganti ring piston/seal klep." },
        { name: "OVERHEATING (KEPANASAN)", rgb: [245, 245, 245], ind: "Putih melepuh, elektroda terkikis drastis.", pen: "Angka oktan terlalu rendah atau pemilihan tipe busi terlalu panas.", sol: "Ganti ke busi tipe dingin (angka lebih tinggi) dan gunakan bensin oktan tinggi." },
        { name: "DETONASI (EXPLOSION DAMAGE)", rgb: [200, 200, 200], ind: "Insulator retak atau pecah-pecah kecil.", pen: "Waktu pengapian terlalu maju (timing tidak tepat) atau bensin basi.", sol: "Setel ulang timing pengapian dan kuras tangki bensin." },
        { name: "DEPOSIT ABU (ASH DEPOSITS)", rgb: [170, 170, 170], ind: "Tumpukan warna coklat muda/putih berpasir tebal.", pen: "Kualitas oli mesin buruk atau pemakaian oli samping berlebih.", sol: "Ganti merek oli mesin dan bersihkan ruang bakar." },
        { name: "GLAZING (MENGKILAP)", rgb: [130, 100, 60], ind: "Coklat tua mengkilap seperti lapisan kaca.", pen: "Suhu ruang bakar naik mendadak saat kecepatan tinggi menyebabkan deposit mencair.", sol: "Busi tidak bisa dibersihkan, harus ganti baru." },
        { name: "BUSI BARU", rgb: [220, 220, 220], ind: "Warna putih bersih tanpa deposit sama sekali.", pen: "Busi belum lama digunakan atau mesin belum mencapai suhu kerja.", sol: "Lanjutkan pemakaian untuk melihat pola pembakaran asli." },
        { name: "SPLASHED DEPOSITS", rgb: [150, 130, 110], ind: "Bintik-bintik gelap menempel tidak merata pada insulator.", pen: "Kerak di ruang bakar lepas dan menempel pada busi setelah servis/tune up.", sol: "Bersihkan busi, kondisi ini biasanya hilang setelah mesin dipakai jalan." },
        { name: "MECHANICAL DAMAGE", rgb: [100, 100, 100], ind: "Elektroda bengkok atau insulator hancur karena hantaman.", pen: "Ada benda asing di ruang bakar atau panjang busi tidak sesuai (mentok piston).", sol: "Ganti busi sesuai kode standar motor dan cek kondisi dalam silinder." },
        { name: "LEAN MISFIRE", rgb: [255, 250, 240], ind: "Warna sangat pucat ke arah kuning.", pen: "Injektor tersumbat atau tekanan pompa bensin lemah.", sol: "Kuras tangki dan bersihkan sistem injeksi (infus injektor)." },
        { name: "SULFUR CORROSION", rgb: [190, 160, 140], ind: "Elektroda berkarat atau berubah warna kehijauan.", pen: "Kualitas bahan bakar rendah dengan kandungan sulfur tinggi.", sol: "Ganti bensin di SPBU yang terpercaya." }
    ];

    const video = document.getElementById('video');
    const photo = document.getElementById('photo-preview');
    const canvas = document.getElementById('canvas');
    const snapBtn = document.getElementById('snap');
    const resetBtn = document.getElementById('reset');

    // Aktifkan Kamera Langsung
    async function initCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment", focusMode: "continuous" } 
            });
            video.srcObject = stream;
        } catch (err) {
            alert("Gagal akses kamera. Pastikan izin diberikan.");
        }
    }

    // Trigger Fokus (Hanya untuk browser yang mendukung)
    function requestAutoFocus() {
        const track = video.srcObject.getVideoTracks()[0];
        const capabilities = track.getCapabilities();
        if (capabilities.focusMode && capabilities.focusMode.includes('continuous')) {
            track.applyConstraints({ advanced: [{ focusMode: 'continuous' }] });
        }
    }

    snapBtn.onclick = () => {
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);

        // Preview foto
        photo.src = canvas.toDataURL('image/jpeg');
        photo.style.display = 'block';
        snapBtn.style.display = 'none';
        resetBtn.style.display = 'block';

        // Analisis warna di area tengah
        const size = 60;
        const x = (canvas.width / 2) - (size / 2);
        const y = (canvas.height / 2) - (size / 2);
        const data = ctx.getImageData(x, y, size, size).data;

        let r=0, g=0, b=0;
        for(let i=0; i<data.length; i+=4) {
            r += data[i]; g += data[i+1]; b += data[i+2];
        }
        const count = data.length / 4;
        diagnosa(Math.round(r/count), Math.round(g/count), Math.round(b/count));
    };

    resetBtn.onclick = () => {
        photo.style.display = 'none';
        snapBtn.style.display = 'block';
        resetBtn.style.display = 'none';
        document.getElementById('res').style.display = 'none';
    };

    function diagnosa(r, g, b) {
        let match = LIBRARY[0];
        let minDiff = Infinity;

        LIBRARY.forEach(item => {
            const d = Math.sqrt(Math.pow(r-item.rgb[0],2) + Math.pow(g-item.rgb[1],2) + Math.pow(b-item.rgb[2],2));
            if(d < minDiff) { minDiff = d; match = item; }
        });

        const hex = "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();
        document.getElementById('res').style.display = 'block';
        document.getElementById('resCol').style.backgroundColor = hex;
        document.getElementById('resHex').innerText = `HEX: ${hex} | RGB: ${r},${g},${b}`;
        document.getElementById('resName').innerText = match.name;
        document.getElementById('resInd').innerText = match.ind;
        document.getElementById('resPen').innerText = match.pen;
        document.getElementById('resSol').innerText = match.sol;
        
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    }

    window.onload = initCamera;
</script>
</body>
</html>
