<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Micro-Scanner Busi - SMKN 1 Sumarorong</title>
    <style>
        :root { --bg: #000000; --panel: #111827; --gold: #fbbf24; --text: #f8fafc; --danger: #ef4444; }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; overflow: hidden; }
        
        /* Layar Kamera Penuh */
        #camera-wrapper { 
            position: relative; width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden; 
        }
        #video { 
            position: absolute; width: 100%; height: 100%; object-fit: cover;
            transform: scale(3.0); /* Zoom Mikroskopik x3.0 */
        }

        /* Overlay Mikroskop */
        .microscope-ui {
            position: absolute; inset: 0; border: 40px solid rgba(0,0,0,0.7); pointer-events: none;
            display: flex; align-items: center; justify-content: center;
        }
        .scanner-box {
            width: 120px; height: 120px; border: 2px solid var(--gold); border-radius: 4px;
            position: relative; background: rgba(251, 191, 36, 0.05);
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.4);
        }
        /* Crosshair Panduan */
        .crosshair {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 100%; height: 1px; background: rgba(251, 191, 36, 0.5);
        }
        .crosshair-v {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 1px; height: 100%; background: rgba(251, 191, 36, 0.5);
        }
        .guide-text {
            position: absolute; bottom: -40px; width: 200px; left: -40px;
            color: var(--gold); font-size: 10px; font-weight: bold; text-align: center; text-transform: uppercase;
        }

        /* Panel Kontrol di Bawah */
        .bottom-panel {
            position: fixed; bottom: 0; width: 100%; background: var(--panel);
            padding: 20px; border-radius: 30px 30px 0 0; border-top: 2px solid var(--gold);
            box-sizing: border-box; z-index: 100; transform: translateY(0); transition: 0.5s;
        }

        .btn-capture {
            background: var(--gold); color: black; border: none; padding: 15px;
            width: 100%; border-radius: 12px; font-weight: 900; font-size: 1rem; cursor: pointer;
        }

        #result-display { display: none; margin-top: 15px; border-top: 1px solid #374151; padding-top: 15px; }
        .res-card { display: flex; gap: 15px; align-items: flex-start; }
        .res-color { width: 60px; height: 60px; border-radius: 12px; border: 2px solid white; flex-shrink: 0; }
        .res-title { color: var(--gold); font-weight: 900; font-size: 1.1rem; text-transform: uppercase; margin: 0; }
        
        .info-grid { display: grid; grid-template-columns: 1fr; gap: 8px; margin-top: 12px; }
        .info-item { background: #1f2937; padding: 10px; border-radius: 8px; font-size: 0.85rem; border-left: 3px solid var(--gold); }
        .info-item label { display: block; font-size: 0.65rem; color: #94a3b8; font-weight: bold; margin-bottom: 2px; }

        #photo-preview { position: absolute; inset: 0; object-fit: cover; display: none; z-index: 10; }
    </style>
</head>
<body>

<div id="camera-wrapper">
    <video id="video" autoplay playsinline></video>
    <img id="photo-preview">
    
    <div class="microscope-ui">
        <div class="scanner-box">
            <div class="crosshair"></div>
            <div class="crosshair-v"></div>
            <div class="guide-text">Fokuskan Elektroda Tengah</div>
        </div>
    </div>
</div>

<div class="bottom-panel" id="panel">
    <div id="result-display">
        <div class="res-card">
            <div id="resCol" class="res-color"></div>
            <div>
                <p id="resName" class="res-title">-</p>
                <small id="resHex" style="color:#94a3b8; font-family:monospace;"></small>
            </div>
        </div>
        <div class="info-grid">
            <div class="info-item"><label>DIAGNOSA KONDISI</label><p id="resInd">-</p></div>
            <div class="info-item"><label>ANALISIS PENYEBAB</label><p id="resPen">-</p></div>
            <div class="info-item" style="border-color: #10b981;"><label>SOLUSI MEKANIK</label><p id="resSol">-</p></div>
        </div>
        <button class="btn-capture" style="background:#374151; color:white; margin-top:10px;" onclick="resetScan()">ULANGI SCAN</button>
    </div>

    <button id="snap" class="btn-capture">AMBIL SAMPEL WARNA</button>
</div>

<canvas id="canvas" style="display:none;"></canvas>

<script>
    const LIBRARY = [
        { name: "Normal / Perfect", rgb: [190, 150, 120], ind: "Pembakaran sempurna. Mesin dalam kondisi prima.", pen: "Campuran udara-bensin pas & busi mencapai suhu pembersihan diri.", sol: "Bersihkan berkala, tidak perlu diganti." },
        { name: "Carbon Fouling", rgb: [45, 45, 45], ind: "Penumpukan karbon kering. Motor brebet di putaran bawah.", pen: "Filter udara kotor atau pilot jet terlalu besar (Boros).", sol: "Bersihkan filter udara & setel ulang karburator/injeksi." },
        { name: "Oil Fouling", rgb: [10, 10, 10], ind: "Busi basah oli. Gejala ring piston aus atau seal klep bocor.", pen: "Oli mesin merembes ke ruang bakar.", sol: "Lakukan Top Overhaul, cek ring piston dan silinder." },
        { name: "Overheated", rgb: [240, 240, 240], ind: "Insulator putih melepuh. Risiko piston bolong.", pen: "Oktan bensin terlalu rendah atau waktu pengapian terlalu maju.", sol: "Ganti bensin oktan tinggi & gunakan busi tipe Dingin (NGK 8/9)." },
        { name: "Glazing (Leleh)", rgb: [130, 90, 50], ind: "Deposit mencair menjadi lapisan kaca.", pen: "Suhu mesin naik mendadak secara ekstrem.", sol: "Ganti busi. Lapisan kaca menghambat percikan api." },
        { name: "Ash Deposits", rgb: [170, 170, 170], ind: "Kerak abu kelabu menumpuk.", pen: "Aditif oli atau bensin tidak terbakar habis.", sol: "Ganti merek oli mesin ke kualitas lebih tinggi." },
        { name: "Detonasi / Pitting", rgb: [210, 210, 210], ind: "Permukaan elektroda bopeng (terkikis hancur).", pen: "Mesin 'ngelitik' parah dalam waktu lama.", sol: "Cek kerak di kepala piston & gunakan bensin oktan tinggi." },
        { name: "Aluminium Splash", rgb: [200, 200, 205], ind: "Ada bintik logam perak menempel di busi.", pen: "Material piston mulai meleleh & menempel ke busi.", sol: "Segera bongkar mesin sebelum piston macet total!" }
    ];

    const video = document.getElementById('video');
    const photo = document.getElementById('photo-preview');
    const snapBtn = document.getElementById('snap');
    const resultDisp = document.getElementById('result-display');
    const canvas = document.getElementById('canvas');

    async function initCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment", focusMode: "continuous" } 
            });
            video.srcObject = stream;
            // Upayakan auto fokus jarak dekat
            const track = stream.getVideoTracks()[0];
            if (track.getCapabilities().focusMode) {
                track.applyConstraints({ advanced: [{ focusMode: "continuous" }] });
            }
        } catch (err) { alert("Izin kamera diperlukan!"); }
    }

    snapBtn.onclick = () => {
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);

        // Ambil area kecil di tengah (Mikro sensing)
        const size = 30; // Area sensing dipersempit untuk ketajaman
        const x = (canvas.width / 2) - (size / 2);
        const y = (canvas.height / 2) - (size / 2);
        const data = ctx.getImageData(x, y, size, size).data;

        let r=0, g=0, b=0;
        for(let i=0; i<data.length; i+=4) { r += data[i]; g += data[i+1]; b += data[i+2]; }
        const count = data.length / 4;
        
        displayResult(Math.round(r/count), Math.round(g/count), Math.round(b/count));
        
        photo.src = canvas.toDataURL('image/jpeg');
        photo.style.display = 'block';
        snapBtn.style.display = 'none';
        resultDisp.style.display = 'block';
    };

    function displayResult(r, g, b) {
        let best = LIBRARY[0];
        let min = Infinity;
        LIBRARY.forEach(item => {
            const d = Math.sqrt(Math.pow(r-item.rgb[0],2) + Math.pow(g-item.rgb[1],2) + Math.pow(b-item.rgb[2],2));
            if(d < min) { min = d; best = item; }
        });

        const hex = "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();
        document.getElementById('resCol').style.backgroundColor = hex;
        document.getElementById('resHex').innerText = `SENSING: ${hex}`;
        document.getElementById('resName').innerText = best.name;
        document.getElementById('resInd').innerText = best.ind;
        document.getElementById('resPen').innerText = best.pen;
        document.getElementById('resSol').innerText = best.sol;
    }

    function resetScan() {
        photo.style.display = 'none';
        snapBtn.style.display = 'block';
        resultDisp.style.display = 'none';
    }

    window.onload = initCamera;
</script>
</body>
</html>
