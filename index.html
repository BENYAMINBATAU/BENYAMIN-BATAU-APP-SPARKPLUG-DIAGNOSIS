<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ultra-Makro Busi Scanner - SMKN 1 Sumarorong</title>
    <style>
        :root { --bg: #020617; --card: #1e293b; --gold: #fbbf24; --blue: #3b82f6; --text: #f8fafc; }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; }
        .card { width: 100%; max-width: 500px; margin: auto; background: var(--card); padding: 20px; border-radius: 30px; box-shadow: 0 25px 50px rgba(0,0,0,0.5); border: 1px solid #334155; box-sizing: border-box; }
        
        .header h1 { font-size: 1.3rem; color: var(--gold); margin: 0; text-transform: uppercase; font-weight: 900; text-align: center; font-style: italic; }
        .header p { font-size: 0.65rem; color: #94a3b8; text-align: center; margin: 5px 0 15px 0; letter-spacing: 2px; font-weight: bold; }

        /* Ultra-Makro Viewport */
        #camera-container { 
            width: 100%; height: 350px; background: #000; border-radius: 20px; 
            margin-bottom: 15px; position: relative; overflow: hidden; border: 3px solid var(--gold);
        }
        /* Zoom effect: scale up the video to act as a 3mm crop focus */
        #video { 
            width: 100%; height: 100%; object-fit: cover; 
            transform: scale(2.5); /* Digital Zoom x2.5 */
        }
        #photo-preview { 
            width: 100%; height: 100%; object-fit: cover; 
            display: none; position: absolute; top:0; left:0;
            transform: scale(1); /* Preview tidak perlu zoom lagi karena sudah tercrop */
        }
        
        /* Makro Target */
        .focus-ring {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 60px; height: 60px; border: 2px solid var(--gold); border-radius: 8px;
            pointer-events: none; box-shadow: 0 0 0 1000px rgba(0,0,0,0.6);
        }
        .focus-ring::after { content: 'CROP 3-5mm'; position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 9px; color: var(--gold); font-weight: 900; white-space: nowrap; }

        .btn { 
            background: var(--gold); color: #000; padding: 18px; border-radius: 15px; 
            font-weight: 900; cursor: pointer; border: none; font-size: 1rem; transition: 0.2s; width: 100%; margin-top: 10px;
        }
        .btn-blue { background: var(--blue); color: white; }

        /* Result Section */
        #res { margin-top: 20px; padding: 15px; background: #020617; border-radius: 20px; display: none; border-left: 6px solid var(--gold); }
        .diag-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .color-sample { width: 45px; height: 45px; border-radius: 12px; border: 2px solid #fff; flex-shrink: 0; }
        
        .box-info { background: #1e293b; padding: 12px; border-radius: 12px; margin-bottom: 8px; border-bottom: 2px solid #334155; }
        .box-info label { display: block; font-size: 0.6rem; color: var(--gold); font-weight: 800; text-transform: uppercase; margin-bottom: 4px; }
        .box-info p { margin: 0; font-size: 0.8rem; line-height: 1.4; color: #f1f5f9; }
        canvas { display: none; }
    </style>
</head>
<body>

<div class="card">
    <div class="header">
        <h1>BENYAMIN BATAU APP</h1>
        <p>MAKRO SCANNER â€¢ TSM SMKN 1 SUMARORONG</p>
    </div>

    <div id="camera-container">
        <video id="video" autoplay playsinline></video>
        <img id="photo-preview">
        <div class="focus-ring"></div>
    </div>

    <div class="controls">
        <button id="snap" class="btn">AMBIL & ANALISIS MAKRO</button>
        <button id="reset" class="btn btn-blue" style="display:none">MULAI ULANG SCAN</button>
    </div>

    <div id="res">
        <div class="diag-header">
            <div id="resCol" class="color-sample"></div>
            <div>
                <div id="resName" style="font-weight:900; color:var(--gold); font-size: 1.1rem; text-transform: uppercase;">-</div>
                <div id="resHex" style="font-size:0.6rem; color:#64748b; font-family:monospace;">HEX: #000000</div>
            </div>
        </div>
        <div class="box-info"><label>Kondisi Visual</label><p id="resInd">-</p></div>
        <div class="box-info"><label>Penyebab Teknis</label><p id="resPen">-</p></div>
        <div class="box-info"><label>Instruksi Perbaikan</label><p id="resSol" style="color:var(--gold); font-weight:bold;">-</p></div>
    </div>
</div>

<canvas id="canvas"></canvas>

<script>
    // PERPUSTAKAAN DATABASE 15 KATEGORI (NGK, DENSO, CHAMPION, RACING STANDARDS)
    const LIBRARY = [
        { name: "Optimal (Tan Color)", rgb: [190, 155, 125], ind: "Warna coklat muda menyerupai biskuit. Campuran udara & bensin sempurna.", pen: "Semua sistem pengapian dan bahan bakar bekerja pada titik efisiensi tertinggi.", sol: "Pertahankan pemakaian. Bersihkan ujung busi dengan sikat kawat halus setiap 4.000 KM." },
        { name: "Carbon Fouling", rgb: [40, 40, 40], ind: "Lapisan jelaga hitam kering menyelimuti insulator elektroda.", pen: "Filter udara sangat kotor, pilot jet terlalu besar, atau mesin jarang mencapai suhu kerja panas.", sol: "Ganti filter udara, servis karburator/injektor. Pastikan pemakaian busi tipe panas (Heat Range rendah)." },
        { name: "Oil Fouling", rgb: [15, 15, 15], ind: "Hitam basah, berminyak, dan licin. Bau oli pada ujung busi.", pen: "Kebocoran oli mesin akibat ring piston aus, seal klep bocor, atau dinding silinder baret.", sol: "Lakukan perbaikan besar (Overhaul). Cek keausan piston dan komponen kepala silinder." },
        { name: "Overheated (Burned)", rgb: [248, 248, 248], ind: "Putih pucat melepuh, elektroda tampak terkikis tajam (meleleh).", pen: "Oktan bensin terlalu rendah atau waktu pengapian terlalu maju (Advance).", sol: "Ganti ke bensin oktan tinggi (Pertamax Turbo) dan gunakan busi tipe Dingin (Cold Type)." },
        { name: "Pre-Ignition Damage", rgb: [210, 210, 210], ind: "Elektroda tengah dan samping meleleh menjadi gumpalan bulat.", pen: "Mesin bekerja di bawah beban ekstrem atau sistem pendingin radiator gagal.", sol: "Cek radiator/kipas, kurangi beban mesin, dan ganti busi baru dengan angka panas lebih besar." },
        { name: "Glazing (Glassy)", rgb: [135, 105, 75], ind: "Insulator tampak mengkilap seperti dilapisi kaca coklat.", pen: "Deposit karbon mencair akibat kenaikan suhu mesin secara mendadak saat kecepatan tinggi.", sol: "Busi tidak dapat dibersihkan secara manual. Ganti busi baru untuk mencegah misfire." },
        { name: "Ash Deposits", rgb: [175, 175, 175], ind: "Kerak abu kelabu menumpuk tebal, menutupi celah elektroda.", pen: "Kualitas oli mesin rendah atau penggunaan aditif bahan bakar yang tidak terbakar habis.", sol: "Kuras tangki bensin dan ganti merk oli mesin dengan kualitas JASO yang sesuai." },
        { name: "Lead Poisoning", rgb: [110, 80, 50], ind: "Bercak coklat kekuningan yang terlihat seragam pada insulator.", pen: "Sisa timbal dari bensin kualitas rendah yang terakumulasi.", sol: "Ganti tempat pengisian BBM dan gunakan cairan carbon cleaner untuk ruang bakar." },
        { name: "Detonation (Pitting)", rgb: [225, 225, 225], ind: "Insulator retak atau terlihat lubang-lubang kecil (pitting) pada elektroda.", pen: "Tekanan kompresi terlalu tinggi atau bensin beroktan sangat rendah (Ngelitik).", sol: "Ganti bensin, setel ulang celah klep, dan cek kerak di atas kepala piston." },
        { name: "Splashed Deposit", rgb: [155, 140, 120], ind: "Bintik-bintik gelap yang tidak merata, seperti percikan kotoran.", pen: "Sisa kerak ruang bakar yang terlepas setelah servis mesin dan menempel pada busi.", sol: "Bereskan pembakaran, busi akan bersih dengan sendirinya setelah dibawa jalan jarak jauh." },
        { name: "Busi Kadaluarsa", rgb: [100, 100, 105], ind: "Elektroda samping terlihat tipis (terkikis) dan insulator kusam.", pen: "Masa pakai busi sudah melewati batas (Biasa > 10.000 KM).", sol: "Segera ganti busi baru untuk menjaga kestabilan stasioner dan akselerasi." },
        { name: "Sulfur Erosion", rgb: [180, 165, 130], ind: "Warna kehijauan atau karat pada logam busi.", pen: "Kelembaban tinggi di ruang bakar atau bensin mengandung sulfur tinggi.", sol: "Servis rutin dan pastikan sistem pernapasan mesin (PCV) tidak tersumbat." },
        { name: "Corona Stain", rgb: [160, 120, 90], ind: "Noda coklat melingkar pada keramik di atas hex busi (Bukan kebocoran).", pen: "Partikel debu yang menempel karena tegangan tinggi pada kabel busi.", sol: "Hanya masalah estetika. Lap dengan kain bersih, busi masih layak pakai." },
        { name: "Aluminium Splash", rgb: [195, 195, 200], ind: "Bintik perak metalik menempel pada insulator.", pen: "Piston mulai terkikis dan material aluminium piston menempel pada busi.", sol: "Sangat Bahaya! Segera cek kondisi piston dan dinding silinder sebelum macet (Jim)." },
        { name: "Busi Baru (Clean)", rgb: [235, 235, 235], ind: "Putih bersih tanpa noda sama sekali.", pen: "Busi baru dipasang atau mesin baru hidup kurang dari 1 menit.", sol: "Lanjutkan pemakaian untuk mendapatkan hasil pembakaran yang akurat." }
    ];

    const video = document.getElementById('video');
    const photo = document.getElementById('photo-preview');
    const snapBtn = document.getElementById('snap');
    const resetBtn = document.getElementById('reset');
    const canvas = document.getElementById('canvas');

    // Memulai Kamera dengan Fokus Makro
    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: "environment", 
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                } 
            });
            video.srcObject = stream;
        } catch (err) {
            alert("Izin kamera ditolak atau tidak didukung.");
        }
    }

    snapBtn.onclick = () => {
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        
        // Sesuaikan ukuran canvas dengan stream asli
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        // Gambar apa yang terlihat di video ke canvas
        ctx.drawImage(video, 0, 0);

        // Ambil Data Pixel dari Area Kotak Kuning (Tengah)
        // Karena video di-zoom x2.5, kita ambil area yang lebih kecil di tengah canvas asli
        const sampleSize = 40;
        const x = (canvas.width / 2) - (sampleSize / 2);
        const y = (canvas.height / 2) - (sampleSize / 2);
        const imgData = ctx.getImageData(x, y, sampleSize, sampleSize).data;

        let r=0, g=0, b=0;
        for(let i=0; i<imgData.length; i+=4) {
            r += imgData[i]; g += imgData[i+1]; b += imgData[i+2];
        }
        const pixelCount = imgData.length / 4;
        const avgR = Math.round(r/pixelCount);
        const avgG = Math.round(g/pixelCount);
        const avgB = Math.round(b/pixelCount);

        // Tampilkan Preview (Hasil jepretan)
        photo.src = canvas.toDataURL('image/jpeg');
        photo.style.display = 'block';
        snapBtn.style.display = 'none';
        resetBtn.style.display = 'block';

        analisisBusi(avgR, avgG, avgB);
    };

    resetBtn.onclick = () => {
        photo.style.display = 'none';
        snapBtn.style.display = 'block';
        resetBtn.style.display = 'none';
        document.getElementById('res').style.display = 'none';
    };

    function analisisBusi(r, g, b) {
        let bestMatch = LIBRARY[0];
        let minDistance = Infinity;

        LIBRARY.forEach(item => {
            const distance = Math.sqrt(
                Math.pow(r - item.rgb[0], 2) +
                Math.pow(g - item.rgb[1], 2) +
                Math.pow(b - item.rgb[2], 2)
            );
            if(distance < minDistance) {
                minDistance = distance;
                bestMatch = item;
            }
        });

        const hex = "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();
        
        document.getElementById('res').style.display = 'block';
        document.getElementById('resCol').style.backgroundColor = hex;
        document.getElementById('resHex').innerText = `HEX: ${hex} | RGB: ${r},${g},${b}`;
        document.getElementById('resName').innerText = bestMatch.name;
        document.getElementById('resInd').innerText = bestMatch.ind;
        document.getElementById('resPen').innerText = bestMatch.pen;
        document.getElementById('resSol').innerText = bestMatch.sol;

        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    }

    window.onload = startCamera;
</script>
</body>
</html>
