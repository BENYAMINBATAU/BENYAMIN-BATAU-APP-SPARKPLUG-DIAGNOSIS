<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner Busi Digital - SMKN 1 Sumarorong</title>
    <style>
        :root { --primary: #0f172a; --gold: #fbbf24; --accent: #2563eb; }
        body { font-family: sans-serif; background: var(--primary); color: white; text-align: center; padding: 20px; margin: 0; }
        .card { max-width: 450px; margin: auto; background: #1e293b; padding: 20px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid #334155; }
        h2 { color: var(--gold); margin: 0; letter-spacing: 1px; }
        #box { width: 100%; height: 280px; background: #000; border-radius: 20px; margin: 20px 0; display: flex; align-items: center; justify-content: center; border: 2px dashed #475569; position: relative; overflow: hidden; }
        img { max-width: 100%; max-height: 100%; display: none; object-fit: contain; }
        .btn { background: var(--gold); color: black; padding: 16px; border: none; border-radius: 14px; font-weight: 900; width: 100%; cursor: pointer; margin-bottom: 10px; font-size: 1rem; transition: 0.3s; }
        .btn:active { transform: scale(0.98); }
        #res { background: #0f172a; padding: 20px; border-radius: 15px; text-align: left; display: none; margin-top: 20px; border-top: 4px solid var(--gold); }
        .color-preview { width: 50px; height: 50px; border-radius: 10px; border: 2px solid white; display: inline-block; vertical-align: middle; margin-right: 15px; }
        .meta-text { font-size: 0.85rem; color: #94a3b8; margin-top: 5px; }
        .result-title { color: var(--gold); font-weight: bold; font-size: 1.1rem; display: block; margin-bottom: 10px; }
        .info-tag { display: inline-block; background: #334155; padding: 4px 10px; border-radius: 6px; font-size: 0.7rem; margin-right: 5px; }
    </style>
</head>
<body>

<div class="card">
    <h2>BENYAMIN BATAU APP</h2>
    <p class="meta-text">Digital Spark Plug Colorimetry Analysis</p>

    <div id="box">
        <span id="label">SIAPKAN FOTO BUSI</span>
        <img id="preview">
        <canvas id="canvas" style="display:none;"></canvas>
    </div>

    <input type="file" id="inp" accept="image/*" capture="camera" style="display:none">
    <button class="btn" onclick="document.getElementById('inp').click()">AMBIL FOTO & ANALISIS</button>

    <div id="res">
        <div style="display:flex; align-items:center; margin-bottom:15px;">
            <div id="detected-color" class="color-preview"></div>
            <div>
                <span id="color-name" class="result-title">Menganalisis...</span>
                <div id="codes" class="meta-text"></div>
            </div>
        </div>
        <div id="details">
            <p id="indikasi" style="color:#f8fafc; font-size:0.95rem;"></p>
            <p id="penyebab" style="color:#cbd5e1; font-size:0.85rem; background:#1e293b; padding:10px; border-radius:8px;"></p>
            <p id="perbaikan" style="color:var(--gold); font-size:0.9rem; font-weight:bold;"></p>
        </div>
    </div>
</div>

<script>
    // LIBRARY DATABASE WARNA BUSI (Champion, Bosch, Denso & Pengalaman Lapangan)
    const BUSI_LIBRARY = [
        {
            name: "Normal (Pembakaran Sempurna)",
            hex: "#D2B48C", rgb: [210, 180, 140],
            indikasi: "Kondisi mesin sangat baik. Pembakaran efisien.",
            penyebab: "Campuran udara-bahan bakar tepat dan sistem pengapian bekerja optimal.",
            perbaikan: "Lanjutkan perawatan rutin. Busi tidak perlu diganti."
        },
        {
            name: "Normal (Busi Baru)",
            hex: "#F5F5F5", rgb: [245, 245, 245],
            indikasi: "Busi baru atau mesin baru dijalankan sebentar.",
            penyebab: "Belum ada deposit karbon yang menempel pada insulator.",
            perbaikan: "Kondisi normal untuk komponen baru."
        },
        {
            name: "Kering / Irit (Lean)",
            hex: "#FFFFFF", rgb: [255, 255, 255],
            indikasi: "Campuran bahan bakar terlalu miskin (terlalu banyak udara).",
            penyebab: "Jet karburator mampet, tekanan pompa bensin rendah, atau kebocoran vakum.",
            perbaikan: "Setel ulang karburator/ECU, cek filter bensin."
        },
        {
            name: "Overheating (Keputihan/Meleleh)",
            hex: "#E0E0E0", rgb: [224, 224, 224],
            indikasi: "Busi terlalu panas (Overheat). Insulator terlihat melepuh.",
            penyebab: "Angka oktan bensin rendah, waktu pengapian terlalu maju, atau pendinginan mesin buruk.",
            perbaikan: "Gunakan bensin oktan lebih tinggi, cek sistem pendingin (radiator/kipas)."
        },
        {
            name: "Carbon Fouling (Hitam Kering)",
            hex: "#333333", rgb: [51, 51, 51],
            indikasi: "Campuran terlalu kaya atau pengapian lemah.",
            penyebab: "Filter udara kotor, choke terjepit, atau sering jalan jarak pendek (mesin belum panas).",
            perbaikan: "Bersihkan filter udara, cek busi (ganti jika perlu), servis sistem bahan bakar."
        },
        {
            name: "Oil Fouling (Hitam Basah)",
            hex: "#1A1A1A", rgb: [26, 26, 26],
            indikasi: "Oli masuk ke ruang bakar.",
            penyebab: "Ring piston aus, seal klep bocor, atau dinding silinder cacat.",
            perbaikan: "Turun mesin (Top/Full Overhaul), ganti ring piston dan seal klep."
        },
        {
            name: "Lead Fouling (Kekuningan/Coklat Tua)",
            hex: "#8B4513", rgb: [139, 69, 19],
            indikasi: "Deposit bahan bakar mengandung timbal atau aditif.",
            penyebab: "Penggunaan bahan bakar kualitas rendah atau aditif yang tidak cocok.",
            perbaikan: "Ganti bahan bakar dan bersihkan ruang bakar."
        },
        {
            name: "Deposit Abu (Ash Deposit)",
            hex: "#BDBDBD", rgb: [189, 189, 189],
            indikasi: "Penumpukan kerak sisa pembakaran aditif oli/bensin.",
            penyebab: "Kualitas oli mesin kurang baik atau pemakaian oli berlebih.",
            perbaikan: "Ganti merek oli, bersihkan kerak pada kepala silinder."
        }
    ];

    const inp = document.getElementById('inp');
    const pre = document.getElementById('preview');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    inp.onchange = (e) => {
        const file = e.target.files[0];
        if(!file) return;

        const reader = new FileReader();
        reader.onload = (ev) => {
            pre.src = ev.target.result;
            pre.style.display = 'block';
            document.getElementById('label').style.display = 'none';
            
            pre.onload = () => {
                analyzeColor();
            };
        };
        reader.readAsDataURL(file);
    };

    function analyzeColor() {
        // Gambar foto ke canvas untuk ambil pixel
        canvas.width = pre.naturalWidth;
        canvas.height = pre.naturalHeight;
        ctx.drawImage(pre, 0, 0);

        // Ambil warna di area tengah (insulator)
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const pixelData = ctx.getImageData(centerX, centerY, 1, 1).data;
        const rgb = [pixelData[0], pixelData[1], pixelData[2]];
        const hex = rgbToHex(rgb[0], rgb[1], rgb[2]);

        displayResult(rgb, hex);
    }

    function rgbToHex(r, g, b) {
        return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();
    }

    function displayResult(detectedRgb, detectedHex) {
        let closest = BUSI_LIBRARY[0];
        let minDiff = Infinity;

        // Algoritma Euclidean Distance untuk cari warna paling mirip di Library
        BUSI_LIBRARY.forEach(item => {
            const diff = Math.sqrt(
                Math.pow(detectedRgb[0] - item.rgb[0], 2) +
                Math.pow(detectedRgb[1] - item.rgb[1], 2) +
                Math.pow(detectedRgb[2] - item.rgb[2], 2)
            );
            if(diff < minDiff) {
                minDiff = diff;
                closest = item;
            }
        });

        document.getElementById('res').style.display = 'block';
        document.getElementById('detected-color').style.backgroundColor = detectedHex;
        document.getElementById('color-name').innerText = closest.name;
        document.getElementById('codes').innerHTML = `HEX: ${detectedHex} | RGB: ${detectedRgb.join(',')}`;
        document.getElementById('indikasi').innerHTML = `<strong>Indikasi:</strong> ${closest.indikasi}`;
        document.getElementById('penyebab').innerHTML = `<strong>Penyebab:</strong> ${closest.penyebab}`;
        document.getElementById('perbaikan').innerHTML = `ðŸ’¡ Langkah: ${closest.perbaikan}`;
        
        window.scrollTo(0, document.body.scrollHeight);
    }
</script>
</body>
</html>
