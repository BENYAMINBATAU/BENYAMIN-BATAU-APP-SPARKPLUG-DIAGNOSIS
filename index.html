<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expert Spark Plug Scanner - SMKN 1 Sumarorong</title>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --gold: #fbbf24; --blue: #3b82f6; --text: #f8fafc; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; display: flex; justify-content: center; }
        .card { width: 100%; max-width: 480px; background: var(--card); padding: 25px; border-radius: 30px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); border: 1px solid #334155; }
        
        .header h1 { font-size: 1.5rem; color: var(--gold); margin: 0; text-transform: uppercase; font-weight: 900; font-style: italic; }
        .header p { font-size: 0.75rem; color: #94a3b8; margin: 5px 0 20px 0; letter-spacing: 2px; }

        /* Camera Box & Focus Target */
        #viewport { 
            width: 100%; height: 320px; background: #000; border-radius: 20px; 
            margin-bottom: 20px; position: relative; overflow: hidden; border: 2px solid #475569;
        }
        #preview { width: 100%; height: 100%; object-fit: contain; display: none; }
        .target-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 80px; height: 80px; border: 2px dashed var(--gold); border-radius: 50%;
            pointer-events: none; display: flex; align-items: center; justify-content: center;
        }
        .target-overlay::after { content: 'FOKUS INSULATOR'; font-size: 8px; color: var(--gold); margin-top: 100px; white-space: nowrap; font-weight: bold; }

        .btn { 
            background: var(--gold); color: #000; padding: 18px; border-radius: 15px; 
            font-weight: 800; cursor: pointer; width: 100%; border: none; font-size: 1rem;
            box-shadow: 0 4px 15px rgba(251, 191, 36, 0.3); transition: 0.2s;
        }
        .btn:active { transform: scale(0.96); }

        /* Result Section */
        #res { margin-top: 25px; padding: 20px; background: #0f172a; border-radius: 20px; display: none; border: 1px solid #334155; text-align: left; }
        .color-circle { width: 45px; height: 45px; border-radius: 12px; border: 2px solid #fff; flex-shrink: 0; }
        .diag-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        
        .box-info { background: #1e293b; padding: 12px; border-radius: 12px; margin-bottom: 10px; border-left: 4px solid var(--blue); }
        .box-info label { display: block; font-size: 0.7rem; color: #94a3b8; font-weight: bold; text-transform: uppercase; margin-bottom: 4px; }
        .box-info p { margin: 0; font-size: 0.9rem; line-height: 1.5; color: #e2e8f0; }
        
        .step-fix { border-left-color: var(--gold); background: rgba(251, 191, 36, 0.05); }
        canvas { display: none; }
    </style>
</head>
<body>

<div class="card">
    <div class="header">
        <h1>BENYAMIN BATAU APP</h1>
        <p>SMKN 1 SUMARORONG â€¢ TSM EXPERT SYSTEM</p>
    </div>

    <div id="viewport">
        <div class="target-overlay" id="guideline"></div>
        <img id="preview" alt="Busi">
        <canvas id="scanCanvas"></canvas>
    </div>

    <input type="file" id="camera" accept="image/*" capture="camera" style="display:none">
    <button class="btn" onclick="document.getElementById('camera').click()">AMBIL FOTO BUSI</button>

    <div id="res">
        <div class="diag-header">
            <div id="colBox" class="color-circle"></div>
            <div>
                <div id="colName" style="font-weight:900; color:var(--gold); font-size: 1.1rem;">-</div>
                <div id="colHex" style="font-size:0.7rem; color:#64748b; font-family:monospace;">HEX: #000000</div>
            </div>
        </div>

        <div class="box-info">
            <label>Analisis Kondisi</label>
            <p id="txtIndikasi">-</p>
        </div>
        <div class="box-info">
            <label>Kemungkinan Penyebab</label>
            <p id="txtPenyebab">-</p>
        </div>
        <div class="box-info step-fix">
            <label>Rekomendasi Perbaikan</label>
            <p id="txtSolusi" style="color:var(--gold); font-weight:bold;">-</p>
        </div>
    </div>
</div>

<script>
    // LIBRARY DATABASE WARNA BUSI (STANDARD NGK, DENSO, CHAMPION)
    const BUSI_DB = [
        {
            name: "NORMAL (OPTIMAL)",
            rgb: [210, 180, 140], hex: "#D2B48C",
            indikasi: "Warna coklat muda / abu-abu (Tan Color). Pembakaran mesin sangat efisien.",
            penyebab: "Campuran udara & bensin pas, waktu pengapian tepat, tingkat panas busi sesuai.",
            solusi: "Kondisi sangat baik. Pertahankan perawatan rutin dan gunakan bensin kualitas stabil."
        },
        {
            name: "BUSI BARU / MESIN DINGIN",
            rgb: [240, 240, 240], hex: "#F0F0F0",
            indikasi: "Insulator masih putih bersih. Belum ada deposit.",
            penyebab: "Busi baru dipasang atau mesin hanya dihidupkan sebentar (belum mencapai suhu kerja).",
            solusi: "Normal untuk komponen baru. Jalankan motor sekitar 15 menit untuk melihat pola pembakaran asli."
        },
        {
            name: "TERLALU IRIT (LEAN)",
            rgb: [255, 255, 255], hex: "#FFFFFF",
            indikasi: "Putih bersih membara. Mesin cenderung cepat panas (Overheating).",
            penyebab: "Campuran bensin terlalu sedikit, ada kebocoran udara di intake, atau spuyer mampet.",
            solusi: "Bersihkan karburator/injektor, cek filter bensin, dan pastikan tidak ada kebocoran pada manifol."
        },
        {
            name: "KERAK KARBON (DRY FOULING)",
            rgb: [40, 40, 40], hex: "#282828",
            indikasi: "Hitam kering berjelaga. Motor susah hidup di pagi hari.",
            penyebab: "Campuran terlalu boros, filter udara sangat kotor, atau motor sering digunakan jarak pendek.",
            solusi: "Bersihkan/ganti filter udara, servis karburator/injeksi. Gunakan busi dengan tingkat panas lebih tinggi."
        },
        {
            name: "KERAK OLI (WET FOULING)",
            rgb: [15, 15, 15], hex: "#0F0F0F",
            indikasi: "Hitam basah dan berminyak. Keluar asap putih dari knalpot.",
            penyebab: "Oli mesin masuk ke ruang bakar karena ring piston aus atau seal klep bocor.",
            solusi: "Perlu bongkar mesin (Overhaul). Segera ganti ring piston dan seal klep untuk mencegah kerusakan silinder."
        },
        {
            name: "OVERHEATING / PRE-IGNITION",
            rgb: [220, 220, 220], hex: "#DCDCDC",
            indikasi: "Insulator putih melepuh, elektroda tampak terkikis/meleleh.",
            penyebab: "Oktan bensin terlalu rendah, pengapian terlalu maju, atau pendinginan mesin gagal.",
            solusi: "Gunakan bensin oktan lebih tinggi (Pertamax/Turbo), cek radiator/kipas, dan gunakan busi 'Cold Type'."
        },
        {
            name: "DEPOSIT ABU (ASH DEPOSIT)",
            rgb: [180, 180, 180], hex: "#B4B4B4",
            indikasi: "Tumpukan kerak berwarna kelabu/putih berpasir di ujung busi.",
            penyebab: "Penggunaan oli samping berkualitas rendah (2-tak) atau aditif bensin yang tidak terbakar habis.",
            solusi: "Ganti merek oli mesin/oli samping yang lebih berkualitas dan bersihkan kepala silinder."
        },
        {
            name: "LEAD FOULING",
            rgb: [100, 70, 40], hex: "#644628",
            indikasi: "Warna coklat tua kekuningan/mengkilap seperti kaca (Glazing).",
            penyebab: "Sisa timbal dari bahan bakar atau aditif yang meleleh saat mesin bekerja pada kecepatan tinggi.",
            solusi: "Ganti busi. Deposit ini tidak bisa dibersihkan dan dapat menyebabkan misfire (brebet)."
        }
    ];

    const camInput = document.getElementById('camera');
    const preview = document.getElementById('preview');
    const canvas = document.getElementById('scanCanvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });

    camInput.onchange = (e) => {
        const file = e.target.files[0];
        if(!file) return;

        const reader = new FileReader();
        reader.onload = (f) => {
            preview.src = f.target.result;
            preview.style.display = 'block';
            document.getElementById('guideline').style.display = 'none';
            
            preview.onload = () => {
                // Gambar ke canvas untuk analisis
                canvas.width = preview.naturalWidth;
                canvas.height = preview.naturalHeight;
                ctx.drawImage(preview, 0, 0);
                
                // Ambil rata-rata warna di area target (Tengah)
                const size = 50; // Luas area sampel
                const x = (canvas.width / 2) - (size / 2);
                const y = (canvas.height / 2) - (size / 2);
                const imgData = ctx.getImageData(x, y, size, size).data;
                
                let r=0, g=0, b=0;
                for(let i=0; i<imgData.length; i+=4) {
                    r += imgData[i]; g += imgData[i+1]; b += imgData[i+2];
                }
                const count = imgData.length / 4;
                const avgR = Math.round(r/count);
                const avgG = Math.round(g/count);
                const avgB = Math.round(b/count);
                
                processDiagnosis(avgR, avgG, avgB);
            };
        };
        reader.readAsDataURL(file);
    };

    function processDiagnosis(r, g, b) {
        let match = BUSI_DB[0];
        let minDiff = Infinity;

        BUSI_DB.forEach(item => {
            // Algoritma Delta-E sederhana (Euclidean distance)
            const diff = Math.sqrt(
                Math.pow(r - item.rgb[0], 2) +
                Math.pow(g - item.rgb[1], 2) +
                Math.pow(b - item.rgb[2], 2)
            );
            if(diff < minDiff) {
                minDiff = diff;
                match = item;
            }
        });

        const hex = "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();
        
        // Tampilkan Hasil
        document.getElementById('res').style.display = 'block';
        document.getElementById('colBox').style.backgroundColor = hex;
        document.getElementById('colHex').innerText = `HEX: ${hex} | RGB: ${r},${g},${b}`;
        document.getElementById('colName').innerText = match.name;
        document.getElementById('txtIndikasi').innerText = match.indikasi;
        document.getElementById('txtPenyebab').innerText = match.penyebab;
        document.getElementById('txtSolusi').innerText = match.solusi;

        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    }
</script>
</body>
</html>
